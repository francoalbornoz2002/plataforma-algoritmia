<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  {{> styles}}
  <style>
    table { font-size: 9px; }
    th, td { padding: 5px; }
  </style>
</head>
<body>
  {{> header}}

  <div class="content">
    <!-- Sección 1: Estado Actual (Gráficos y Tabla) -->
    <h3 style="color: #1976d2; margin-bottom: 10px; font-size: 14px;">Estado Actual de Dificultades</h3>
    
    <div style="display: flex; justify-content: space-between; margin: 20px 0; page-break-inside: avoid;">
      <div style="width: 48%;">
        <div class="chart-container" style="height: 200px; margin: 0;">
          <canvas id="chartGrado"></canvas>
        </div>
      </div>
      <div style="width: 48%;">
        <div class="chart-container" style="height: 200px; margin: 0;">
          <canvas id="chartTema"></canvas>
        </div>
      </div>
    </div>

    <h4 style="color: #555; margin-bottom: 5px; font-size: 12px;">Detalle de Dificultades Activas</h4>
    <table style="margin-bottom: 20px;">
        <thead>
            <tr>
                <th>Dificultad</th>
                <th>Tema</th>
                <th>Grado Actual</th>
            </tr>
        </thead>
        <tbody>
            {{#each currentDifficulties}}
            <tr>
                <td>{{this.nombre}}</td>
                <td>{{this.tema}}</td>
                <td>{{this.grado}}</td>
            </tr>
            {{/each}}
            {{#unless currentDifficulties}}
            <tr><td colspan="3" style="text-align:center;">No hay dificultades activas.</td></tr>
            {{/unless}}
        </tbody>
    </table>

    <!-- Sección 2: Fuente de Mejora -->
    <h3 style="color: #1976d2; margin-bottom: 10px; font-size: 14px; margin-top: 20px;">Fuente de Mejora</h3>
    <div class="top-stats-grid">
      <div class="top-card" style="border-top: 4px solid #2e7d32;">
        <div class="stat-title">Total de Mejoras</div>
        <div class="stat-value" style="color: #2e7d32;">{{stats.totalMejoras}}</div>
      </div>
      <div class="top-card" style="border-top: 4px solid #1976d2;">
        <div class="stat-title">Vía Videojuego</div>
        <div class="stat-value" style="color: #1976d2;">{{stats.porcentajeVideojuego}}%</div>
      </div>
      <div class="top-card" style="border-top: 4px solid #9c27b0;">
        <div class="stat-title">Vía Sesiones</div>
        <div class="stat-value" style="color: #9c27b0;">{{stats.porcentajeSesion}}%</div>
      </div>
    </div>

    <!-- Sección 3: Evolución -->
    <div class="chart-container" style="height: 350px; margin: 20px 0;">
      <canvas id="chartEvolution"></canvas>
    </div>

    <!-- Sección 4: Historial -->
    <h3 style="color: #1976d2; margin-bottom: 10px; margin-top: 20px; font-size: 14px;">Historial de Cambios</h3>
    
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Dificultad</th>
          <th>Tema</th>
          <th>Cambio</th>
          <th>Fuente</th>
        </tr>
      </thead>
      <tbody>
        {{#each history}}
        <tr>
          <td>{{this.fecha}}</td>
          <td>{{this.dificultad}}</td>
          <td>{{this.tema}}</td>
          <td>
            {{this.gradoAnterior}} &rarr; {{this.gradoNuevo}}
            {{#if this.esMejora}}
              <span style="color: #2e7d32; font-weight: bold;">(Mejora)</span>
            {{/if}}
          </td>
          <td>{{this.fuente}}</td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>

  {{> footer}}

  <script>
    {{{chartJsContent}}}
  </script>
  {{> chartSetup}}
  <script>
    const ctxGrado = document.getElementById('chartGrado').getContext('2d');
    const configGrado = {{{chartConfigGrado}}};
    applyChartPrintConfig(configGrado);
    new Chart(ctxGrado, configGrado);

    const ctxTema = document.getElementById('chartTema').getContext('2d');
    const configTema = {{{chartConfigTema}}};
    applyChartPrintConfig(configTema);
    new Chart(ctxTema, configTema);

    const ctxEvo = document.getElementById('chartEvolution').getContext('2d');
    const configEvo = {{{chartConfigEvolution}}};
    configEvo.options.scales.y.ticks.callback = function(value) {
        return ['Ninguno', 'Bajo', 'Medio', 'Alto'][value] || '';
    };
    applyChartPrintConfig(configEvo);
    new Chart(ctxEvo, configEvo);
  </script>
</body>
</html>